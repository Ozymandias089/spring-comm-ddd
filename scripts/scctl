#!/usr/bin/env bash
set -euo pipefail

# --- 기본 설정 ---
ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
SCRIPTS_DIR="${ROOT_DIR}/scripts"
CASES_DIR="${SCRIPTS_DIR}/cases"
ENV_DIR="${SCRIPTS_DIR}/env"
ARTIFACTS_DIR="${ROOT_DIR}/artifacts"

source "${SCRIPTS_DIR}/lib.sh"

# --- 기본 값 ---
ENV_NAME="${ENV_NAME:-dev}"         # --env 로 변경 가능
COOKIES_PATH=""                      # 지정 없으면 mktemp
KEEP_COOKIES=false                   # --keep-cookies 활성화 시 보존
VERBOSE=false

usage() {
  cat <<EOF
scctl - SpringComm 테스트 실행기

Usage:
  scctl [global options] <command> [command options]

Global options:
  --env <dev|stage|prod>   환경 선택 (default: dev)
  --cookies <path>         쿠키 파일 경로 지정 (기본: 임시 파일, 자동 삭제)
  --keep-cookies           쿠키 자동 삭제하지 않음
  -v|--verbose             상세 출력
  -h|--help                도움말

Commands:
  login                    세션 생성(로그인)
  csrf                     CSRF 마스킹 토큰 발급
  patch-display-name       표시명 변경 (cases/patch-display-name.sh)
  logout                   로그아웃
  run <case> [args...]     cases/ 하위 스크립트 실행 (예: scctl run patch-display-name --name "foo")

Examples:
  scctl login
  scctl run patch-display-name --name "hello world"
  scctl --env stage --keep-cookies run patch-display-name --name "stage name"
EOF
}

# --- 파라미터 파싱 ---
CMD=""
ARGS=()
while [[ $# -gt 0 ]]; do
  case "$1" in
    --env) ENV_NAME="$2"; shift 2;;
    --cookies) COOKIES_PATH="$2"; shift 2;;
    --keep-cookies) KEEP_COOKIES=true; shift;;
    -v|--verbose) VERBOSE=true; shift;;
    -h|--help) usage; exit 0;;
    login|csrf|logout|run|patch-display-name) CMD="$1"; shift; ARGS=("$@"); break;;
    *) echo "Unknown arg: $1"; usage; exit 1;;
  esac
done

[[ -z "${CMD}" ]] && { usage; exit 1; }

# --- 환경 로드 ---
ENV_FILE="${ENV_DIR}/${ENV_NAME}.env"
[[ -f "${ENV_FILE}" ]] || die "환경 파일 없음: ${ENV_FILE}"
source "${ENV_FILE}"

mkdir -p "${ARTIFACTS_DIR}"

# --- 쿠키 파일 준비 (기본: 임시) ---
if [[ -z "${COOKIES_PATH}" ]]; then
  COOKIES_PATH="$(mktemp -t scctl.cookies.XXXXXX)"
  AUTO_CLEAN=true
else
  AUTO_CLEAN=false
fi

# 실행 종료 시 쿠키/임시 로그 삭제
cleanup() {
  if [[ "${AUTO_CLEAN}" == true && "${KEEP_COOKIES}" != true ]]; then
    rm -f "${COOKIES_PATH}" || true
  fi
}
trap cleanup EXIT

[[ "${VERBOSE}" == true ]] && {
  echo "ENV=${ENV_NAME}"
  echo "BASE_URL=${BASE_URL}"
  echo "COOKIES_PATH=${COOKIES_PATH}"
  echo
}

# --- 공통 컨텍스트 환경변수 export ---
export BASE_URL COOKIES_PATH ARTIFACTS_DIR VERBOSE

# --- 커맨드 실행 ---
case "${CMD}" in
  login)          sc_login ;;
  csrf)           sc_csrf ;;
  logout)         sc_logout ;;
  patch-display-name)
                   "${CASES_DIR}/patch-display-name.sh" "${ARGS[@]}" ;;
  run)
    [[ ${#ARGS[@]} -lt 1 ]] && die "Usage: scctl run <case> [args...]"
    CASE_NAME="${ARGS[0]}"; shift || true
    CASE_PATH="${CASES_DIR}/${CASE_NAME}.sh"
    [[ -f "${CASE_PATH}" ]] || die "케이스 없음: ${CASE_PATH}"
    "${CASE_PATH}" "${ARGS[@]}"
    ;;
esac
